# Master Board State Machine

The master board runs a state machine that handles the differents stages of communication and errors that can occur.

State machine description and behaviour
---
[![master board state machine diagram](https://mermaid.ink/img/eyJjb2RlIjoic3RhdGVEaWFncmFtXG4gICAgc3RhdGUgXCJTRVRVUFwiIGFzIFNFVFVQOiBTZXR0aW5nIHVwIGFsbCBjb21wb25lbnRzXG4gICAgc3RhdGUgXCJXQUlUSU5HX0ZPUl9JTklUXCIgYXMgV0FJVElOR19GT1JfSU5JVDogV2FpdHMgZm9yIGFuIEluaXQgcGFja2V0IGZyb20gUENcbiAgICBzdGF0ZSBcIlNFTkRJTkdfSU5JVF9BQ0tcIiBhcyBTRU5ESU5HX0lOSVRfQUNLOiBTZW5kaW5nIEFja25vd2xlZGdlbWVudCBwYWNrZXQgdG8gUENcbiAgICBzdGF0ZSBcIkFDVElWRV9DT05UUk9MXCIgYXMgQUNUSVZFX0NPTlRST0w6IFJvYm90IGFjdGl2ZWx5IGNvbnRyb2xsZWQgYnkgdGhlIFBDXG4gICAgc3RhdGUgXCJXSUZJX0VUSF9MSU5LX0RPV05cIiBhcyBXSUZJX0VUSF9MSU5LX0RPV046IEV0aGVybmV0IGxpbmsgaXMgZG93blxuICAgIHN0YXRlIFwiV0lGSV9FVEhfRVJST1JcIiBhcyBXSUZJX0VUSF9FUlJPUjogVGltZW91dCwgbm8gcGFja2V0IGZyb20gUENcblxuICAgIFsqXSAtLT4gU0VUVVBcbiAgICBTRVRVUCAtLT4gV0FJVElOR19GT1JfSU5JVDogU2V0dXAgZG9uZSBpbiBXaUZpXG4gICAgU0VUVVAgLS0-IFdJRklfRVRIX0xJTktfRE9XTjogU2V0dXAgZG9uZSBpbiBFdGhlcm5ldFxuXG4gICAgV0FJVElOR19GT1JfSU5JVCAtLT4gU0VORElOR19JTklUX0FDSzogSW5pdCBwYWNrZXQgcmVjZWl2ZWRcblxuICAgIFNFTkRJTkdfSU5JVF9BQ0sgLS0-IFdJRklfRVRIX0VSUk9SOiBUaW1lb3V0IGFja25vd2xlZGdlbWVudFxuICAgIFNFTkRJTkdfSU5JVF9BQ0sgLS0-IEFDVElWRV9DT05UUk9MOiBGaXJzdCBjb21tYW5kIHBhY2tldCByZWNlaXZlZFxuXG4gICAgV0lGSV9FVEhfRVJST1IgLS0-IFNFTkRJTkdfSU5JVF9BQ0s6IEluaXQgcGFja2V0IHJlY2VpdmVkXG5cbiAgICBBQ1RJVkVfQ09OVFJPTCAtLT4gV0lGSV9FVEhfRVJST1I6IFRpbWVvdXQgY29udHJvbFxuXG4gICAgV0lGSV9FVEhfTElOS19ET1dOIC0tPiBXQUlUSU5HX0ZPUl9JTklUOiBFdGhlcm5ldCBMaW5rIFVwXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtXG4gICAgc3RhdGUgXCJTRVRVUFwiIGFzIFNFVFVQOiBTZXR0aW5nIHVwIGFsbCBjb21wb25lbnRzXG4gICAgc3RhdGUgXCJXQUlUSU5HX0ZPUl9JTklUXCIgYXMgV0FJVElOR19GT1JfSU5JVDogV2FpdHMgZm9yIGFuIEluaXQgcGFja2V0IGZyb20gUENcbiAgICBzdGF0ZSBcIlNFTkRJTkdfSU5JVF9BQ0tcIiBhcyBTRU5ESU5HX0lOSVRfQUNLOiBTZW5kaW5nIEFja25vd2xlZGdlbWVudCBwYWNrZXQgdG8gUENcbiAgICBzdGF0ZSBcIkFDVElWRV9DT05UUk9MXCIgYXMgQUNUSVZFX0NPTlRST0w6IFJvYm90IGFjdGl2ZWx5IGNvbnRyb2xsZWQgYnkgdGhlIFBDXG4gICAgc3RhdGUgXCJXSUZJX0VUSF9MSU5LX0RPV05cIiBhcyBXSUZJX0VUSF9MSU5LX0RPV046IEV0aGVybmV0IGxpbmsgaXMgZG93blxuICAgIHN0YXRlIFwiV0lGSV9FVEhfRVJST1JcIiBhcyBXSUZJX0VUSF9FUlJPUjogVGltZW91dCwgbm8gcGFja2V0IGZyb20gUENcblxuICAgIFsqXSAtLT4gU0VUVVBcbiAgICBTRVRVUCAtLT4gV0FJVElOR19GT1JfSU5JVDogU2V0dXAgZG9uZSBpbiBXaUZpXG4gICAgU0VUVVAgLS0-IFdJRklfRVRIX0xJTktfRE9XTjogU2V0dXAgZG9uZSBpbiBFdGhlcm5ldFxuXG4gICAgV0FJVElOR19GT1JfSU5JVCAtLT4gU0VORElOR19JTklUX0FDSzogSW5pdCBwYWNrZXQgcmVjZWl2ZWRcblxuICAgIFNFTkRJTkdfSU5JVF9BQ0sgLS0-IFdJRklfRVRIX0VSUk9SOiBUaW1lb3V0IGFja25vd2xlZGdlbWVudFxuICAgIFNFTkRJTkdfSU5JVF9BQ0sgLS0-IEFDVElWRV9DT05UUk9MOiBGaXJzdCBjb21tYW5kIHBhY2tldCByZWNlaXZlZFxuXG4gICAgV0lGSV9FVEhfRVJST1IgLS0-IFNFTkRJTkdfSU5JVF9BQ0s6IEluaXQgcGFja2V0IHJlY2VpdmVkXG5cbiAgICBBQ1RJVkVfQ09OVFJPTCAtLT4gV0lGSV9FVEhfRVJST1I6IFRpbWVvdXQgY29udHJvbFxuXG4gICAgV0lGSV9FVEhfTElOS19ET1dOIC0tPiBXQUlUSU5HX0ZPUl9JTklUOiBFdGhlcm5ldCBMaW5rIFVwXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ)
Diagram generated using [Mermaid](https://github.com/mermaid-js/mermaid) Live Editor, click on picture to edit.

Please note that **WIFI_ETH_LINK_DOWN** state is accessible from any state via a callback on the ethernet link down event, but links have not been drawn for the sake of readability.

State machine LED code
---
To each state is associated a LED behaviour.

State | LED behaviour
--- | ---
SETUP | Steady White
WAITING_FOR_INIT | Red Fade
SENDING_INIT_ACK | Blue Fade
ACTIVE_CONTROL | Green Fade
WIFI_ETH_LINK_DOWN | Yellow Blink
WIFI_ETH_ETH_ERROR | Red Blink